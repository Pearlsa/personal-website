<!doctype html><html><head><title>Tracking all the plays or how I learned to stop worrying and build my own Last.fm - charlieegan3</title><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><meta name=description content="For my latest side project I built a tool to better track the music I listen to. I now have a single BigQuery table with my play history from Spotify, Youtube, Soundcloud and Shazam."><meta name=twitter:card content="summary"><meta name=twitter:site content="@charlieegan3"><meta name=twitter:creator content="@charlieegan3"><meta property="og:url" content="https://charlieegan3.com/posts/2018-11-20-how-i-learned-to-stop-worrying-and-build-my-own-lastfm/"><meta property="og:title" content="Tracking all the plays or how I learned to stop worrying and build my own Last.fm"><meta property="og:description" content="For my latest side project I built a tool to better track the music I listen to. I now have a single BigQuery table with my play history from Spotify, Youtube, Soundcloud and Shazam."><meta property="og:type" content="article"><meta name=author content="Charlie Egan"><meta property="article:author" content="https://twitter.com/charlieegan3"><meta property="article:published_time" content="2018-11-20T23:22:48"><link rel=stylesheet type=text/css href=/css/bundle.min.c144bb18591ee3d9ef85fb73056afa69f6c8fa31188080cb491de5b71bbf36e1.css><script type=text/javascript src=/js/bundle.min.76c0ad1f61fe83a23628b79ecc5aa835224071f00c5f2a4fbbdf26765027d8e7.js integrity="sha256-dsCtH2H+g6I2KLeezFqoNSJAcfAMXypPu98mdlAn2Oc="></script></head><body class="bg-darker-gray light-silver"><section class="mw7 center pa3 ph5-ns pb5"><nav class=sidebar-nav><a href=/ title=homepage>home</a>
<a href=/about/ title="read all about it">about</a>
<a class="bb bw1 b--silver" href=/posts/ title="view my blog posts">posts</a>
<a href=/projects/ title="view my projects">projects</a>
<a href=/profiles/ title="find me elsewhere">profiles</a>
<a href=/search><img class="fr grow" style=width:20px;filer:invert(.75);-webkit-filter:invert(.75) src=/search.svg></a></nav><h1 class="f3-ns f4">Tracking all the plays or how I learned to stop worrying and build my own Last.fm</h1><div class="f5-ns f6 gray bb bw1 pb2 b--dark-gray">Posted Nov 20 2018</div><div class=post-content><p>For my latest side project I built a tool to better track the music I listen to.
I now have a single BigQuery table with my play history from Spotify, Youtube,
Soundcloud and Shazam. I also have a <a href=https://music.charlieegan3.com/>simple
site</a> to present the data.</p><p>In this post I explain why I did this, exactly what I&rsquo;ve built and what I might
do next with the project.</p><h1 id=_why_-i-was-loosing-play-data><em>Why:</em> I was loosing play data</h1><p>I&rsquo;ve been a long time <a href=https://www.last.fm/user/charlieegan3>Last.fm user</a>.
When I first started &lsquo;scrobbling&rsquo; to the service I used iTunes but the bulk of
the data on my profile there has come from the Spotify integration.</p><p>I&rsquo;m very grateful for this feature. Had it not been there, the benefits to me of
using Spotify on multiple devices would have outweighed the hassle in tracking
my plays. Thanks to this feature, I&rsquo;ve got a great starting point for my new
project.</p><p>However, I found that the integration was a little flakey and I was loosing play
data. Sometimes I&rsquo;d be signed out of Last.fm after an update and I&rsquo;d not realise
I needed to sign back in.</p><p>This was the first reason that prompted me to think about investigating this
problem.</p><h1 id=_why_-i-wanted-to-own-my-data><em>Why:</em> I wanted to &lsquo;own&rsquo; my data</h1><p>Last.fm are very nice to me. They store my plays and present them back to my
with a some nice graphs and views.</p><p>However, it&rsquo;s not very flexible. I can&rsquo;t write my own views and I don&rsquo;t have
access to the raw data to ask the questions I want. On top of that, I don&rsquo;t
think the few visualizations I use are that hard to recreate.</p><p>I&rsquo;ve been trying to follow on from my <a href=https://photos.charlieegan3.com/>photos
project</a> project and maintain a separate
presentation of my social profiles that I control.</p><p>My play data seemed like a good candidate. It was &lsquo;larger&rsquo; than the photos
dataset and I thought it would provide some new challenges and learnings (which
it did, spoiler alert, oops, that was all backwards, sorry-not-sorry).</p><h1 id=_why_-i-wanted-to-track-other-sources-without-a-lastfm-client><em>Why:</em> I wanted to track other sources without a Last.fm client</h1><p>Last.fm clients were an option and something I experimented with. I found the
Android options to be OK but ultimately unsuitable.</p><p>I found myself listening to music on Soundcloud and
<a href=https://youtu.be/67HOjCV8dqA>Youtube</a> a (little) more often and wanted to save
this play data too.</p><h1 id=_why_-i-wanted-to-track-other-events-and-information><em>Why:</em> I wanted to track other events and information</h1><p>Eventually, I wanted to start tracking additional events beyond plays. Some
examples:</p><ul><li>Which tracks were added and removed from my playlists and when</li><li>How long the tracks were that I was listening to (Last.fm didn&rsquo;t seem to
expose much here)</li><li>erm, that&rsquo;s about it actually</li></ul><p>Now onto the what I did to address this pressing first-world problem I faced.</p><h1 id=_what_-i-built-a-bigquery-table--a-program-to-push-data-from-spotify><em>What:</em> I &lsquo;built&rsquo; a BigQuery table & a program to push data from Spotify</h1><p>First I wrote a simple program that make a call to the Spotify API to get the
recent plays for the current user (me). This list is limited to 50 so it needs
to be run quite regularly to ensure all the data is captured.</p><p>This program is packaged as a container and run every 15 mins as a <code>CronJob</code> on
my personal cluster.</p><p>It queries the list of already saved tracks to get the most recent one. It then
iterates over each of the played tracks and imports all of the tracks played
after the latest of the last import (in ascending order).</p><p>This has been the first project where I&rsquo;ve done the whole Terraform from the
ground up thing too (which involved a little legwork to move some existing
resources under Terraform). There are a few resources outside of Kubernetes
including a Google Cloud project, BigQuery table, some storage buckets and a
service account.</p><p>There have been a few iterations on the table schema but this is the current
field list. Everything just goes into one big table.</p><pre><code>track
artist
album
timestamp
created_at
duration
album_cover

source

spotify_id
youtube_id
youtube_category_id
soundcloud_id
soundcloud_permalink
shazam_id
shazam_permalink
</code></pre><p>With this data, I can do some fun things&mldr;</p><p>Count the plays for each track:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span>
  track,
  artist,
  <span style=color:#66d9ef>count</span>(track) <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>count</span>,
  STRING_AGG(album, <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> <span style=color:#66d9ef>LENGTH</span>(album) <span style=color:#66d9ef>DESC</span> <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>as</span> album,
  ANY_VALUE(duration) <span style=color:#66d9ef>as</span> duration,
  ANY_VALUE(spotify_id) <span style=color:#66d9ef>as</span> spotify_id,
	STRING_AGG(album_cover, <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> <span style=color:#66d9ef>LENGTH</span>(album_cover) <span style=color:#66d9ef>DESC</span> <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>as</span> artwork
<span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>charlieegan3<span style=color:#f92672>-</span>music<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>.music.plays<span style=color:#f92672>`</span>
<span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> track, artist
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> artist <span style=color:#66d9ef>ASC</span>, <span style=color:#66d9ef>count</span> <span style=color:#66d9ef>DESC</span>
</code></pre></div><p>Get my 10 most recent Shazams (see next section):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> track, artist, <span style=color:#66d9ef>timestamp</span>
<span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>charlieegan3<span style=color:#f92672>-</span>music<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>.music.plays<span style=color:#f92672>`</span>
<span style=color:#66d9ef>WHERE</span> <span style=color:#66d9ef>source</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;shazam&#34;</span>
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> <span style=color:#66d9ef>timestamp</span> <span style=color:#66d9ef>DESC</span>
<span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>10</span>
</code></pre></div><p>Get a sorted list of my top Halo soundtrack plays across all the different
albums.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span> artist, track, album, <span style=color:#66d9ef>count</span>(track) <span style=color:#66d9ef>as</span> play_count
<span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>charlieegan3<span style=color:#f92672>-</span>music<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>.music.plays<span style=color:#f92672>`</span>
<span style=color:#66d9ef>WHERE</span> REGEXP_CONTAINS(album, r<span style=color:#e6db74>&#39;Halo&#39;</span>)
<span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> artist, track, album
<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> play_count <span style=color:#66d9ef>DESC</span>
</code></pre></div><h1 id=_what_-next-i-built-a-website--some-more-integrations><em>What:</em> Next, I built a website & some more integrations</h1><p>I wanted to go end-to-end quickly and have a simple &lsquo;view&rsquo; into this dataset I
was accumulating. The site is at
<a href=https://music.charlieegan3.com/>music.charlieegan3.com</a>.</p><p>It has a few pages. Each page is based on a single JSON file built from one or
more queries made against BigQuery. The recent plays file is updated every 15
mins, the others are less regular. They&rsquo;re all stored in a Google Cloud Storage
bucket. The site itself (not the JSON data) is served from an nginx container in
the cluster (makes the subdomain config and updates more similar to my other
projects. General rule for new projects if it&rsquo;s stateless, it runs in the
cluster).</p><p>I also built some more integrations (a key requirement of the project). Youtube
came first after Spotify - it was really hard. Youtube&rsquo;s API no longer exposes
the &lsquo;Watch History&rsquo; &lsquo;Playlist&rsquo;. It used to be accessible as a playlist with the
ID <code>WH</code> but that was disabled a few years ago - I suspect for privacy reasons.
Still, it seems a shame to me that I can&rsquo;t get the data for my own account&mldr;</p><p>To get around this I needed to fall back to my roots and build a scraper - just
like old times. Youtube&rsquo;s page is rendered from &lsquo;initial data&rsquo; served as part of
the page. This is JSON, yay. It is also a complete labyrinth, boo. I was able to
use <a href=https://github.com/tomnomnom/gron>gron</a> and to grep out the parts
of the JSON I was interested in and used
<a href=https://github.com/ChimeraCoder/gojson>gojson</a> to generate a struct to
unmarshal it into.</p><p>This took ages but in the end I was able to get the metadata from the content ID
table for each video in a format that was good enough to save into my table.</p><p>I also built similar scrapers for Shazam and Soundcloud but they&rsquo;re DOM /
private APIs were much less surprising.</p><p>So far I&rsquo;ve been running these for about a month and they&rsquo;ve not broken -
fingers crossed. I&rsquo;m used to playing the scraper time bomb waiting game.</p><h1 id=_where-next_-some-ideas-for-the-future><em>Where Next:</em> Some ideas for the future</h1><p>Visualizations. At the moment there is only one graph on the site - the plays
month. This is about as good as my charts get. Luckily ma boi, @tlfrd is on the
case with a <a href=https://beta.observablehq.com/@tlfrd/plays>proof-of-concept &lsquo;viz&rsquo;</a>
showing the lifetime play history for individual songs. I&rsquo;m really interested in
improving the presentations of the data in time. However, now the collection
side of the project is in place I&rsquo;m going to be pausing for a bit.</p><p>Another idea I had was to send email summaries each week showing my play data. I
think this might also serve as quite a good monitoring function (i.e. to check
that the data matches what I remember listening to).</p><p>I&rsquo;m also considering syncing the data back to Last.fm or
<a href=https://libre.fm/>Libre.fm</a> but I think this is close to the bottom of the
list for me at the moment.</p><p>So there we have it. Another rushed post about a side project that&rsquo;s been
distracting me recently.</p><p>I&rsquo;m enjoying this as a general direction for my side projects though. Personal
Analytics / Quantified Self is so much more than calorie counting. The data&rsquo;s
there, you&rsquo;ve just got to get it.</p></div></section></body></html>