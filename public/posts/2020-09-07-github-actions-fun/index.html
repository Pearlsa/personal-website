<!doctype html><html><head><title>Fun things I‚Äôm doing with GitHub Actions
- charlieegan3</title><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><meta name=description content="Two years ago, GitHub announced Actions, their repo-integrated, workflow automation product. It took me ages to get access, then when I finally did, it seemed to get a bit of a bad review for being rough around the edges."><meta name=twitter:card content="summary"><meta name=twitter:site content="@charlieegan3"><meta name=twitter:creator content="@charlieegan3"><meta property="og:url" content="https://charlieegan3.com/posts/2020-09-07-github-actions-fun/"><meta property="og:title" content="Fun things I‚Äôm doing with GitHub Actions"><meta property="og:description" content="Two years ago, GitHub announced Actions, their repo-integrated, workflow automation product. It took me ages to get access, then when I finally did, it seemed to get a bit of a bad review for being rough around the edges."><meta property="og:type" content="article"><meta name=author content="Charlie Egan"><meta property="article:author" content="https://twitter.com/charlieegan3"><meta property="article:published_time" content="2020-09-07T07:00:00"><meta property="og:image" content="https://charlieegan3.com/posts/2020-09-07-github-actions-fun/live.png"><link rel=stylesheet type=text/css href=/css/bundle.min.c144bb18591ee3d9ef85fb73056afa69f6c8fa31188080cb491de5b71bbf36e1.css><script type=text/javascript src=/js/bundle.min.76c0ad1f61fe83a23628b79ecc5aa835224071f00c5f2a4fbbdf26765027d8e7.js integrity="sha256-dsCtH2H+g6I2KLeezFqoNSJAcfAMXypPu98mdlAn2Oc="></script></head><body class="bg-darker-gray light-silver"><section class="mw7 center pa3 ph5-ns pb5"><nav class=sidebar-nav><a href=/ title=homepage>home</a>
<a href=/about/ title="read all about it">about</a>
<a class="bb bw1 b--silver" href=/posts/ title="view my blog posts">posts</a>
<a href=/projects/ title="view my projects">projects</a>
<a href=/profiles/ title="find me elsewhere">profiles</a>
<a href=/search><img class="fr grow" style=width:20px;filer:invert(.75);-webkit-filter:invert(.75) src=/search.svg></a></nav><h1 class="f3-ns f4">Fun things I‚Äôm doing with GitHub Actions</h1><div class="f5-ns f6 gray bb bw1 pb2 b--dark-gray">Posted Sep 7 2020</div><div class=post-content><p>Two years ago, GitHub announced <em>Actions,</em> their repo-integrated, workflow automation product. It took me ages to get access, then when I finally did, it seemed to get a bit of a bad review for being rough around the edges. Roll on 6 months and I‚Äôm having a great time with it. This posts is a list of the fun things I‚Äôm doing with GitHub Actions - spoiler alert, not many really seem to fit the intended use case&mldr;</p><h2 id=charlieegan3charlieegan3>charlieegan3/charlieegan3</h2><p>Starting out with the most self-centered & self-promoting entry in the list is my repo that updates <a href=https://github.com/charlieegan3>my own GitHub profile</a>. At the time of writing, it looks like this:</p><p><img src=profile.png alt=profile.png></p><p>This section of the page shows the readme of the <a href=https://github.com/charlieegan3/charlieegan3>charlieegan3/charlieegan3 repo</a>. In that repo I have a <a href=https://github.com/charlieegan3/charlieegan3/blob/fa92f0cbfacf6820873b699d7a5bdf9e355b05bf/hack/update_readme.rb>script</a> that gets this information from my website and replicates it here. It also has a little emoji for the city at the time of day it‚Äôs meant to be for me here in London. This little project was my GitHub Actions gateway drug!</p><p>Sadly it‚Äôs not especially easy to replicate, mostly that script just processes <a href=https://charlieegan3.github.io/json-charlieegan3/build/status.json>the data</a> that‚Äôs updated by another, older project called <a href=https://github.com/charlieegan3/json-charlieegan3>json-charlieegan3</a>. Which leads me on to&mldr;</p><h2 id=json-charlieegan3>json-charlieegan3</h2><p>This project is older than GitHub Actions, but now runs there too. It‚Äôs long been responsible for updating this little ‚Äòlive‚Äô section on my site. It‚Äôs run in all kinds of places before, from Heroku to GKE to my Raspberry Pi cluster to&mldr; ü•Å GitHub Actions!</p><p><img src=live.png alt=live.png></p><p>This one makes use of git/GitHub as the storage too and shares the generated JSON file via GitHub pages with <a href=http://charlieegan3.com>charlieegan3.com</a>. Committing and pushing from Actions is pretty nice as you don‚Äôt need to configure the access to the repo, just update the files and commit the result back. This works in the same way as charlieegan3/charlieegan3 for the profile README update.</p><h2 id=personal-website>personal-website</h2><p>My personal website is now, once again, back on GitHub. I use actions to build the site with <a href=https://gohugo.io/>Hugo</a> and to commit the result to a <code>netlify</code> branch. This is then picked up and deployed to Netlify. I don‚Äôt use pages for my personal site to keep <a href=http://charlieegan3.github.io>charlieegan3.github.io</a> simple and my other Pages sites working.</p><p>This is pretty boring, everyone and their mum has a Hugo site these days&mldr; what makes this interesting?</p><p>So glad you asked. I‚Äôve also got a script that can import page content and posts from <a href=https://notion.so>Notion</a>. I <a href=https://github.com/charlieegan3/personal-website/blob/master/bin/export_notion.rb>make use of the export functionality</a> to get a zip of the page called ‚Äò<em>Website</em>‚Äô and all it‚Äôs children pages. Using this data, I then have a script to <a href=https://github.com/charlieegan3/personal-website/blob/master/bin/import_notion.rb>import</a> this into the existing Hugo site.</p><p>This is all a bit of a hack, but it seems to work really nicely. This post is the second to be written using Notion as the ‚ÄòCMS‚Äô (Content Management System). What‚Äôs nice about using Notion for me is that it takes the friction out of writing on my iPad. I can import images and format the post easily.</p><p>To actually update the repo, I make use of this little known(?) GitHub Actions feature called <code>workflow_dispatch</code>. It looks a bit like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>on</span>:
  <span style=color:#66d9ef>workflow_dispatch</span>:
    <span style=color:#66d9ef>inputs</span>:
      <span style=color:#66d9ef>commitSubject</span>:
        <span style=color:#66d9ef>description</span>: Subject
        <span style=color:#66d9ef>required</span>: <span style=color:#66d9ef>true</span>
      <span style=color:#66d9ef>commitDetail</span>:
        <span style=color:#66d9ef>description</span>: Detail
        <span style=color:#66d9ef>required</span>: <span style=color:#66d9ef>false</span>
</code></pre></div><p>These two fields allow me to set the commit message Subject and detail. GitHub uses this to generate the form like this:</p><p><img src=trigger.png alt=trigger.png></p><p>Then when I click <code>Run workflow</code> I get my site updated from Notion with a nice commit message explaining what‚Äôs been added.</p><p>At work we once had lunch with a professional blogger. One of the things he explained was important was reducing the friction to update and create content. This seemed so simple, and I‚Äôve taken it to heart. Before last weekend, I didn‚Äôt have the path from WYSIWYG ‚Üí published site properly automated, now I do and this is my second post in 2 weeks. Not committing to that schedule, but it‚Äôs just an interesting change for me.</p><h2 id=notion-export--dropbox-backup>notion-export & dropbox-backup</h2><p>You won‚Äôt find these repos on my profile as I‚Äôm keen to keep the GitHub Actions run state and logs private. I‚Äôve not yet worked out who can see what in the logs on public repos.</p><p>These repos don‚Äôt use Actions for anything related to git or GitHub, they just run jobs on a schedule.</p><p><strong>notion-export</strong> downloads a full copy of my Notion workspace and uploads it to Dropbox.</p><p>Exporting the data is much the same as it is to <a href=https://github.com/charlieegan3/personal-website/blob/f5c916ffc598693de1dd789a03f16869f330706f/bin/export_notion.rb>get the data for the website</a>. The upload is super simple too with the <code>[dropbox_api</code>gem](<a href=https://github.com/Jesus/dropbox_api)>https://github.com/Jesus/dropbox_api)</a>. I find Dropbox‚Äôs API access story to be so much better than Google Drive and all the others. Dropbox isn‚Äôt without faults, but it does seem to be the most user friendly cloud storage as a one-man-band user trying to organise and automate the dull stuff.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>require <span style=color:#e6db74>&#34;dropbox_api&#34;</span>

ts <span style=color:#f92672>=</span> <span style=color:#66d9ef>Time</span><span style=color:#f92672>.</span>now<span style=color:#f92672>.</span>utc<span style=color:#f92672>.</span>strftime(<span style=color:#e6db74>&#34;%Y-%m-%d&#34;</span>)

client <span style=color:#f92672>=</span> <span style=color:#66d9ef>DropboxApi</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Client</span><span style=color:#f92672>.</span>new(<span style=color:#66d9ef>ENV</span><span style=color:#f92672>.</span>fetch(<span style=color:#e6db74>&#34;DROPBOX_TOKEN&#34;</span>))
<span style=color:#66d9ef>File</span><span style=color:#f92672>.</span>open(<span style=color:#e6db74>&#34;export.zip&#34;</span>) <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>f<span style=color:#f92672>|</span>
  client<span style=color:#f92672>.</span>upload_by_chunks(
    <span style=color:#e6db74>&#34;/Archive/Account Exports/notion-</span><span style=color:#e6db74>#{</span>ts<span style=color:#e6db74>}</span><span style=color:#e6db74>.zip&#34;</span>,
    f,
    {
      <span style=color:#e6db74>mode</span>: <span style=color:#e6db74>&#34;overwrite&#34;</span>
    }
  )
<span style=color:#66d9ef>end</span>
</code></pre></div><p><strong>dropbox-backup</strong> might be a rather unexpected project. I don‚Äôt know anyone else that backs up their personal cloud storage. My school computing teacher said that computers allow you to make mistakes very quickly, I‚Äôm sure that‚Äôs not original, but it stuck with me. I make reasonably heavy use of automation and bulk update tools like <a href=http://rclone.org/>Rclone</a> to manage my Dropbox and since it contains things like the only digital copy of photos going back as far as 1950, paying BackBlaze ¬£2 a month for some space in b2 felt worth it.</p><p>This repo contains only the GitHub Actions manifest really:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>on</span>:
  <span style=color:#66d9ef>schedule</span>:
  - <span style=color:#66d9ef>cron</span>: <span style=color:#e6db74>&#39;0 1 1,15 * *&#39;</span>
<span style=color:#66d9ef>jobs</span>:
  <span style=color:#66d9ef>build</span>:
    <span style=color:#66d9ef>runs-on</span>: ubuntu-latest
    <span style=color:#66d9ef>steps</span>:
    - <span style=color:#66d9ef>uses</span>: actions/checkout@v2
      <span style=color:#66d9ef>with</span>:
        <span style=color:#66d9ef>fetch-depth</span>: <span style=color:#ae81ff>0</span>
    - <span style=color:#66d9ef>name</span>: Install rclone
      <span style=color:#66d9ef>run</span>: <span style=color:#e6db74>|
</span><span style=color:#e6db74>        curl https://rclone.org/install.sh | sudo bash</span>
    - <span style=color:#66d9ef>name</span>: Run sync
      <span style=color:#66d9ef>shell</span>: bash
      <span style=color:#66d9ef>env</span>:
        <span style=color:#66d9ef>RCLONE_CONFIG</span>: ${{ secrets.RCLONE_CONFIG }}
      <span style=color:#66d9ef>run</span>: <span style=color:#e6db74>|
</span><span style=color:#e6db74>        set -ex</span>
        echo $RCLONE_CONFIG | base64 -d &gt; rclone.conf
        rclone \
          --config rclone.conf \
          sync \
          <span style=color:#e6db74>&#34;dropbox:/&#34;</span> \
          <span style=color:#e6db74>&#34;bb:bucket-name/&#34;</span> \
          --exclude <span style=color:#e6db74>&#34;Vault/**&#34;</span>
</code></pre></div><p>Here we see a really clear example of Actions as ‚Äòcron-as-a-service‚Äô, and I suppose a secret store too for Rclone config.</p><h2 id=photos--music>photos & music</h2><p>My two ‚Äòflagship‚Äô (lol) projects are my <a href=https://github.com/charlieegan3/photos>Instagram-driven & enhanced photo library</a> and my <a href=https://github.com/charlieegan3/music>musical memory crutch</a>. Both these projects refresh their data using GitHub actions.</p><p><strong>photos</strong> downloads new post data, downloads missing locations, and then stores the media from the post in object storage. It then commits the updated data files which kicks off another action to build the site and push it to the <code>netlify</code> branch. Seems like a pretty good fit, but I need to make the requests to Instagram via my residential proxy these days. The GitHub IPs appear to be unable to make the same requests&mldr;</p><p><strong>music</strong> does quite <a href=https://github.com/charlieegan3/music/tree/master/.github/workflows>a lot more</a>&mldr; in summary, the following tasks are all running in Actions:</p><ul><li>Data refresh (download play data and store in BigQuery)<ul><li>Spotify</li><li>Shazam</li><li>Soundcloud</li><li>YouTube</li></ul></li><li>Summarization (save the results of a query to object storage for the website to consume)<ul><li>Home page overview (plays by month, top tracks and artists per year)</li><li>Recent plays</li><li>Top monthly plays</li><li>Tracks per artist to generate search index</li></ul></li><li>‚ÄòEnriching‚Äô data. Operations to complete missing data and consolidate a number of consistencies. Saving the result back to another BigQuery table.</li><li>Generating the artist pages and updating the Hugo site at <a href=http://music.charlieegan3.com>music.charlieegan3.com</a></li><li>Backing up the play data to GCS (in case I screw it up, which has happened before)</li><li>Monitoring probe to test for missing data and send alerts</li></ul><p>I was hoping that this final example would show that GitHub Actions can be the glue to tie together git, object storage, external services and static sites into something that looks like an ‚Äòapplication‚Äô.</p><hr><p>So that‚Äôs how I‚Äôm using GitHub actions, as of today.</p><p>I plan to use it more since it‚Äôs free and seems to be pretty reliable.</p><p><strong>Why not use k8s?</strong> Can‚Äôt really be bothered maintaining things that I want to ‚Äòjust-work‚Äô on my pi cluster that sometimes gets dripped on and breaks. My new rule is if it‚Äôs used by anyone other than me, then I run it on someone else‚Äôs cloud - not the little one in my house, GitHub Actions has been a big part of that shift.</p><p><strong>Why not run these on [insert cloud here]?</strong> Actions is free, and integrated with git.</p><p><strong>Why not use [insert other free cron tool]?</strong> I probably haven‚Äôt heard of it and it doesn‚Äôt integrate as nicely with git.</p></div></section></body></html>