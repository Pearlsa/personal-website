<!doctype html><html><head><title>Fun things I did in Rego while validating Christmas Trees - charlieegan3</title><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><meta name=description content="I&rsquo;ve been working on fun project recently for the &lsquo;Christmas Show & Tell&rsquo; event at the London Computation Club. At club show and tells there are imaginary points available for matching the theme."><meta name=twitter:card content="summary"><meta name=twitter:site content="@charlieegan3"><meta name=twitter:creator content="@charlieegan3"><meta property="og:url" content="https://charlieegan3.com/posts/2019-12-05-rego-fun/"><meta property="og:title" content="Fun things I did in Rego while validating Christmas Trees"><meta property="og:description" content="I&rsquo;ve been working on fun project recently for the &lsquo;Christmas Show & Tell&rsquo; event at the London Computation Club. At club show and tells there are imaginary points available for matching the theme."><meta property="og:type" content="article"><meta name=author content="Charlie Egan"><meta property="article:author" content="https://twitter.com/charlieegan3"><meta property="article:published_time" content="2019-12-05T21:53:39"><link rel=stylesheet type=text/css href=/css/bundle.min.c144bb18591ee3d9ef85fb73056afa69f6c8fa31188080cb491de5b71bbf36e1.css><script type=text/javascript src=/js/bundle.min.76c0ad1f61fe83a23628b79ecc5aa835224071f00c5f2a4fbbdf26765027d8e7.js integrity="sha256-dsCtH2H+g6I2KLeezFqoNSJAcfAMXypPu98mdlAn2Oc="></script></head><body class="bg-darker-gray light-silver"><section class="mw7 center pa3 ph5-ns pb5"><nav class=sidebar-nav><a href=/ title=homepage>home</a>
<a href=/about/ title="read all about it">about</a>
<a class="bb bw1 b--silver" href=/posts/ title="view my blog posts">posts</a>
<a href=/projects/ title="view my projects">projects</a>
<a href=/profiles/ title="find me elsewhere">profiles</a>
<a href=/search><img class="fr grow" style=width:20px;filer:invert(.75);-webkit-filter:invert(.75) src=/search.svg></a></nav><h1 class="f3-ns f4">Fun things I did in Rego while validating Christmas Trees</h1><div class="f5-ns f6 gray bb bw1 pb2 b--dark-gray">Posted Dec 5 2019</div><div class=post-content><p>I&rsquo;ve been working on fun project recently for the &lsquo;Christmas Show & Tell&rsquo; event
at the London Computation Club. At club show and tells there are imaginary
points available for matching the theme. I like imaginary points and decided to
make a system that would validate drawings of Christmas trees using
<a href=https://www.openpolicyagent.org/>OPA</a> &
<a href=https://www.openpolicyagent.org/docs/latest/policy-language/>Rego</a>.</p><p>If you&rsquo;re interested in playing with the tool I demoed, you can find it
<a href=https://xmas-trees.charlieegan3.com/>here</a>. This post is more about the Rego I
found myself writing as part of the project.</p><h2 id=opa-handlers--gathering-it-all-up>OPA &lsquo;handlers&rsquo; & gathering it all up</h2><p>Quite some time ago I
<a href=https://github.com/open-policy-agent/opa/issues/1818>learned</a> about the
(apparently little known) <code>v0</code> <a href=https://www.openpolicyagent.org/docs/latest/rest-api/#get-a-document-webhook>Data
API</a>
on the OPA server. This makes it easy to map different requests to different
policies on the same OPA server instance. Even though I have only one policy to
validate my trees - I used this method to run my <code>main.rego</code> policy
<a href=https://github.com/charlieegan3/policing-christmas-trees/blob/b90a6cfe064defebaec5aee89b48f11aed78a044/server/main.rego>here</a>.</p><p>The most interesting part of this policy is how the messages from my various
<code>deny</code> policies are aggregated.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>output</span> = {<span style=color:#a6e22e>m</span> | <span style=color:#a6e22e>m</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>deny</span>[<span style=color:#a6e22e>_</span>]}
</code></pre></div><p>There&rsquo;s a few things going on here.</p><ul><li>I see <code>deny[_]</code> as finding all solutions to <code>deny</code> (where <code>deny</code> is a policy
that returns a message if the input is invalid) - basically gathering all the
messages for the input.</li><li><code>{m | m := deny[_]}</code> is gathering up all these messages using a
<a href=https://www.openpolicyagent.org/docs/latest/policy-language/#comprehensions>comprehension</a>.
Crucially, these messages are aggregated into a Set not a list (e.g. <code>[m | m := deny[_]]</code>) - this is important because sometimes there are many identical
reasons an input can be invalid for a given input.</li></ul><p>I <a href=https://stackoverflow.com/questions/58895492/limit-opa-rego-to-a-single-rule-solution>asked</a>
if it were possible to halt the execution once a solution had been found.
Thinking about the domain for which OPA was built, it&rsquo;s perhaps
unsurprising that it is not.</p><h2 id=a-humble-membership-test>A humble membership test</h2><p>I&rsquo;m not including
<a href=https://github.com/charlieegan3/policing-christmas-trees/blob/dda4a8f92e9c09781782a11610769bc85ccfd596/server/topper.rego#L4-L11>this</a>
because I think it&rsquo;s especially wow but rather as an
example of something basic I&rsquo;d never needed to do before in the policies I&rsquo;d
written at work.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>allowed_toppers</span> <span style=color:#f92672>:=</span> {<span style=color:#e6db74>&#34;angel&#34;</span>, <span style=color:#e6db74>&#34;star&#34;</span>}
<span style=color:#a6e22e>allowed_toppers</span> <span style=color:#f92672>&amp;</span> {<span style=color:#a6e22e>input</span>} <span style=color:#f92672>==</span> <span style=color:#a6e22e>set</span>()
<span style=color:#a6e22e>message</span> <span style=color:#f92672>:=</span>
  <span style=color:#a6e22e>sprintf</span>(<span style=color:#e6db74>&#34;topper &#39;%s&#39; not in list: %s&#34;</span>, [<span style=color:#a6e22e>input</span>, <span style=color:#a6e22e>concat</span>(<span style=color:#e6db74>&#34;,&#34;</span>, <span style=color:#a6e22e>allowed_toppers</span>)])
</code></pre></div><p>This allows me to validate that the input is within some known good static set
of strings. We assert that if the intersection of the set of the input and the
known set is empty (<code>set()</code>) then we must bind to the error message.</p><p>In this particular it&rsquo;s quite easy to explain why the input is invalid in the
message too.</p><h2 id=universal-quantifications>Universal Quantifications</h2><p>I ended up reaching for Universal Quantifications twice in this project -
something I&rsquo;d not used before in Rego.</p><p>When validating <a href=https://github.com/charlieegan3/policing-christmas-trees/blob/b90a6cfe064defebaec5aee89b48f11aed78a044/server/baubles.rego#L9-L12>baubles</a>
I found that I needed to validate that it was placed on a single point on the
tree outline. This lead me to create a simple test to ensure that there as
matching point.</p><p>You might be thinking that this sounds more like an <em>Existential
Quantification</em>. All my policies are written as <code>deny</code> - I&rsquo;m not sure why but
this is how I&rsquo;d always done it at work and it seemed to make sense to continue.</p><p>What it does mean is that to assert that there exists a point on the outline,
you need to describe the error case as being when the count of all matching
points is zero. It&rsquo;s kinda backwards.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>count</span>({<span style=color:#a6e22e>point</span> |
	<span style=color:#a6e22e>point</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>input</span>.<span style=color:#a6e22e>outline</span>[<span style=color:#a6e22e>_</span>]
	<span style=color:#a6e22e>point</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>bauble</span>
}) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>
</code></pre></div><p>I realise now this can be condensed some to the form below, but I think the
original is more readable.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>count</span>({<span style=color:#a6e22e>point</span> |
	<span style=color:#a6e22e>input</span>.<span style=color:#a6e22e>outline</span>[<span style=color:#a6e22e>point</span>] <span style=color:#f92672>==</span> <span style=color:#a6e22e>bauble</span>
}) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>
</code></pre></div><p>I needed to do a similar thing for <a href=https://github.com/charlieegan3/policing-christmas-trees/blob/b90a6cfe064defebaec5aee89b48f11aed78a044/server/tinsels.rego#L21>tinsels</a>.
Tinsel start and end points must be on a segment of the tree outline. Here the
checking logic is more involved so I&rsquo;ve written it up in the next section. The
idea is the same though really where I&rsquo;m using Universal Quantification to
validate a solution exists.</p><h2 id=why-eeq-wals-em-ex-plus-see>why-eeq-wals-em-ex-plus-see</h2><p><code>y = mx + c</code> was also something I&rsquo;d not needed to use when validating Kubernetes
YAMLs.</p><p>The reason tinsels were harder than baubles is that they can lie between two
points on the outline (but they <em>must</em> be on the outline). The only way I knew
do this was with the <a href=https://github.com/charlieegan3/policing-christmas-trees/blob/b90a6cfe064defebaec5aee89b48f11aed78a044/server/tinsels.rego#L34-L42>line
equation</a>
and <a href=https://github.com/charlieegan3/policing-christmas-trees/blob/b90a6cfe064defebaec5aee89b48f11aed78a044/server/tinsels.rego#L44-L52>bounds
checking</a>
on the coordinate values
so that&rsquo;s what I did - in Rego ofc!</p><p>First I calculate the gradient and intercept for the outline segment:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>gradient</span> <span style=color:#f92672>:=</span> (<span style=color:#a6e22e>outline_point_a</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>-</span> <span style=color:#a6e22e>outline_point_b</span>[<span style=color:#ae81ff>1</span>]) <span style=color:#f92672>/</span>
			(<span style=color:#a6e22e>outline_point_a</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>-</span> <span style=color:#a6e22e>outline_point_b</span>[<span style=color:#ae81ff>0</span>])

<span style=color:#a6e22e>y_intercept</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>*</span>((<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#f92672>*</span><span style=color:#a6e22e>outline_point_a</span>[<span style=color:#ae81ff>1</span>]) <span style=color:#f92672>+</span> (<span style=color:#a6e22e>gradient</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>outline_point_a</span>[<span style=color:#ae81ff>0</span>]))
</code></pre></div><p>Then I can plug the point for the tinsel into this and find out if we&rsquo;re good.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>expected_y</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gradient</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>point</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>+</span> <span style=color:#a6e22e>y_intercept</span>
<span style=color:#a6e22e>expected_y</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>point</span>[<span style=color:#ae81ff>1</span>]
</code></pre></div><hr><p>So there you have it. Some things I did in Rego in the name of festive fun.</p><p>In the new year I&rsquo;m going to be spending my time working on Jetstack&rsquo;s
<a href=https://github.com/jetstack/preflight><em>Preflight</em></a>, an open source tool for
infrastructure policy checking built on Rego. Hopefully that will be fun too.</p></div></section></body></html>