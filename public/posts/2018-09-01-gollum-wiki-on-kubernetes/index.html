<!doctype html><html><head><title>Running a wiki with Gollum on Kubernetes - charlieegan3</title><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><meta name=description content="I&rsquo;ve long been searching for a good, self-hosted, personal wiki. I went as far to build my own with client-side encryption running on Heroku as a Rails app."><meta name=twitter:card content="summary"><meta name=twitter:site content="@charlieegan3"><meta name=twitter:creator content="@charlieegan3"><meta property="og:url" content="https://charlieegan3.com/posts/2018-09-01-gollum-wiki-on-kubernetes/"><meta property="og:title" content="Running a wiki with Gollum on Kubernetes"><meta property="og:description" content="I&rsquo;ve long been searching for a good, self-hosted, personal wiki. I went as far to build my own with client-side encryption running on Heroku as a Rails app."><meta property="og:type" content="article"><meta name=author content="Charlie Egan"><meta property="article:author" content="https://twitter.com/charlieegan3"><meta property="article:published_time" content="2018-09-01T18:20:12"><meta property="og:image" content="https://charlieegan3.com/posts/2018-09-01-gollum-wiki-on-kubernetes/patrick-tomasso-71909-unsplash.jpg"><link rel=stylesheet type=text/css href=/css/bundle.min.c144bb18591ee3d9ef85fb73056afa69f6c8fa31188080cb491de5b71bbf36e1.css><script type=text/javascript src=/js/bundle.min.76c0ad1f61fe83a23628b79ecc5aa835224071f00c5f2a4fbbdf26765027d8e7.js integrity="sha256-dsCtH2H+g6I2KLeezFqoNSJAcfAMXypPu98mdlAn2Oc="></script></head><body class="bg-darker-gray light-silver"><section class="mw7 center pa3 ph5-ns pb5"><nav class=sidebar-nav><a href=/ title=homepage>home</a>
<a href=/about/ title="read all about it">about</a>
<a class="bb bw1 b--silver" href=/posts/ title="view my blog posts">posts</a>
<a href=/projects/ title="view my projects">projects</a>
<a href=/profiles/ title="find me elsewhere">profiles</a>
<a href=/search><img class="fr grow" style=width:20px;filer:invert(.75);-webkit-filter:invert(.75) src=/search.svg></a></nav><h1 class="f3-ns f4">Running a wiki with Gollum on Kubernetes</h1><div class="f5-ns f6 gray bb bw1 pb2 b--dark-gray">Posted Sep 1 2018</div><div class=post-content><p>I&rsquo;ve long been
<a href=/blog/2017/01/12/heroku-treasure>searching</a> for a
good, self-hosted, personal wiki. I went as far to build my own with client-side
encryption running on Heroku as a Rails app. I guess this was version 1. This
post is about version 2.</p><h2 id=why>Why</h2><p><strong>Why was version 1 not good enough?</strong></p><ul><li>It ran on the free tier of Heroku and had to boot for 10 seconds whenever I
needed to use it, this was a pain as my use was quite infrequent.</li><li>I didn&rsquo;t want to pay $7 a month to keep it running full time.</li><li>The client side encryption method I&rsquo;d built using SJCL was cool but clunky. All
the decryption needed to happen on the client, this made exporting data in
bulk harder than I&rsquo;d expected.</li><li>The decryption key was also stored in local storage which seemed to get
cleared out more regularly than I&rsquo;d expected.</li></ul><p><strong>Why even do this at all?</strong></p><p>I&rsquo;m moving all my side-projects to Kubernetes. Some deets on my cluster <a href=/posts/2018-08-15-cheap-gke-cluster-zero-loadbalancers>here</a>.</p><p><strong>Why not run version 1 on Kubernetes then?</strong></p><p>I didn&rsquo;t want to run the database for it in-cluster. Some of the information in
the wiki I&rsquo;m really keen to keep. I want to store the wiki in git.</p><h2 id=what>What</h2><p>While looking for a git based wiki, I came across
<a href=https://github.com/gollum/gollum>gollum</a>. gollum is a ruby gem that runs a
local server that interacts with the git index to both serve and store content.
I liked it and decided to experiment with getting it running. There were some
additional requirements:</p><ul><li>This needs to be stored encrypted</li><li>Only I should have access.</li></ul><p>These pose some problems. Before, if I&rsquo;d needed files to be encrypted in git,
I&rsquo;d used <a href=https://github.com/AGWA/git-crypt>git-crypt</a>. git-crypt is easy to
use, you add GPG keys, specify files to be encrypted in a <code>.gitattributes</code> file
and that&rsquo;s it really. Sadly, it&rsquo;s not possible to use this on a repo with
gollum. gollum reads files to show them on wiki pages and forms <em>from the git
index</em> - not the local file system. With git-crypt, the files are stored in the
index encrypted. I needed something else.</p><p>Enter, <a href=https://github.com/spwhitton/git-remote-gcrypt><code>git-remote-gcrypt</code></a>.
This is a package that adds some functionality to git. It is invoked
automatically with a URI prefix in a git remote:</p><pre><code>gcrypt::https://example.com/user/repo.git
</code></pre><p>As opposed to:</p><pre><code>https://example.com/user/repo.git
</code></pre><p>Rather than individual files being encrypted in the index as they are with
git-crypt, the entire git index is encrypted when interacting with the remote.</p><p>This means that the local copy of the git index is clear and can be read by
gollum - hooray!</p><p>The only other feature I needed to replicate in the new version was
authorization. I needed to make sure that only I was able to read and update the
wiki. gollum is designed to be run as a local server in a local repo so doesn&rsquo;t
have any features for this out of the box. I wanted to have access to it from my
other devices too.</p><p>I decided to solve this with the <a href=https://github.com/bitly/oauth2_proxy>bit.ly oauth2 proxy</a>.
It&rsquo;s possible to configure nginx running as an ingress controller to use the
oauth2_proxy for certain backends. This is easily configured with the
<a href=https://github.com/kubernetes/ingress-nginx/blob/master/docs/examples/auth/oauth-external-auth/README.md>following guide</a>.</p><p>With this setup, I had a means of only allowing traffic into the service that
passed my oauth check (to have my email).</p><h3 id=gollum-server>&lsquo;gollum-server&rsquo;</h3><p>I should also explain how this all fits together and works with gollum running
in a container. There&rsquo;s a tricky bit and it&rsquo;s to do with GPG&mldr;</p><p>This is the Dockerfile for the service, pretty harmless right?</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> ruby:2.4</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get remove gnupg -y<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get update <span style=color:#f92672>&amp;&amp;</span> apt-get install -y gnupg2 git-remote-gcrypt vim expect<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> gem install gollum -v 4.1.2<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> entrypoint.sh /entrypoint.sh<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENTRYPOINT</span> [<span style=color:#e6db74>&#34;/entrypoint.sh&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> []<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>What about that entrypoint though? Not so much. What does this container need to
do?</p><ol><li>Download the wiki</li><li>Decrypt the wiki</li><li>Serve the wiki</li><li>Push updates made by gollum to back to the wiki&rsquo;s repo</li></ol><p>I&rsquo;ll break it down.</p><h4 id=1-configure-the-containers-git-installation>1. Configure the container&rsquo;s git installation:</h4><p>Note that we&rsquo;re settings some flags for gcrypt here too. I learned what to
set here from <a href=http://git-annex.branchable.com/tips/fully_encrypted_git_repositories_with_gcrypt/>this
page</a> - I think&mldr;</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>git config --global user.email <span style=color:#e6db74>&#34;wiki@example.com&#34;</span>
git config --global user.name <span style=color:#e6db74>&#34;Wiki Robot&#34;</span>

git config --global --add gcrypt.publish-participants true
git config --global --add gcrypt.participants $GPG_KEY_ID
git config --global user.signingkey $GPG_KEY_ID
git config --global commit.gpgsign true
</code></pre></div><h4 id=2-save-the-credentials-to-download-the-repo-from-github>2. Save the credentials to download the repo from GitHub:</h4><p>These are stored as a secret in Kubernetes and available as environment
variables.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mkdir -p ~/.ssh
echo $SSH_PUBLIC &gt; ~/.ssh/id_rsa.pub
echo $SSH_PRIVATE | awk <span style=color:#e6db74>&#39;{gsub(/\\n/,&#34;\n&#34;)}1&#39;</span> &gt; ~/.ssh/id_rsa
echo $GITHUB_COM_KEY &gt; ~/.ssh/known_hosts
chmod <span style=color:#ae81ff>0400</span> ~/.ssh/*
</code></pre></div><h4 id=3-do-the-same-for-gpg-and-configure-it>3. Do the same for GPG and configure it.</h4><p>I set the cache-ttl to be long so that I only need to do the pinentry once.
GPG pinentry is a major pain & the hardest part about making this while
project work.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mkdir ~/.gpg
echo $GPG_PUBLIC | awk <span style=color:#e6db74>&#39;{gsub(/\\n/,&#34;\n&#34;)}1&#39;</span> | base64 -d &gt; ~/.gpg/public.key
echo $GPG_PRIVATE | awk <span style=color:#e6db74>&#39;{gsub(/\\n/,&#34;\n&#34;)}1&#39;</span> | base64 -d &gt; ~/.gpg/private.key
gpg --pinentry-mode loopback --passphrase<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$GPG_PASSPHRASE<span style=color:#e6db74>&#34;</span> --import ~/.gpg/*.key

echo <span style=color:#e6db74>&#34;pinentry-mode loopback&#34;</span> &gt;&gt; ~/.gnupg/gpg.conf
echo <span style=color:#e6db74>&#34;pinentry-mode loopback&#34;</span> &gt;&gt; ~/.gnupg/gpg-agent.conf
echo <span style=color:#e6db74>&#34;default-cache-ttl 34560000&#34;</span> &gt;&gt; ~/.gnupg/gpg-agent.conf
echo <span style=color:#e6db74>&#34;maximum-cache-ttl 34560000&#34;</span> &gt;&gt; ~/.gnupg/gpg-agent.conf
echo <span style=color:#e6db74>&#34;max-cache-ttl 34560000&#34;</span> &gt;&gt; ~/.gnupg/gpg-agent.conf
gpg-connect-agent reloadagent /bye
</code></pre></div><h4 id=4-create-a-passphrase-expect-script-to-handle-the-first-and-only-gpg-prompt>4. Create a passphrase expect script to handle the first and only GPG prompt:</h4><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cat &gt; /usr/local/bin/passphrase <span style=color:#e6db74>&lt;&lt;EOF
</span><span style=color:#e6db74>#!/usr/bin/expect
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>set timeout 60
</span><span style=color:#e6db74>set command [lindex \$argv 0]
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>eval spawn &#34;\$command&#34;
</span><span style=color:#e6db74>expect &#34;Enter passphrase:&#34; { send -- &#34;$GPG_PASSPHRASE\n&#34; }
</span><span style=color:#e6db74>expect eof
</span><span style=color:#e6db74>EOF</span>

chmod +x /usr/local/bin/passphrase
</code></pre></div><h4 id=5-use-this-massive-great-whopping-hack-to-clone-the-repo-from-github>5. Use this massive, great, whopping HACK to clone the repo from GitHub:</h4><p>Since we set a high ttl, we aren&rsquo;t prompted on future operations with GPG,
thank <em>god</em>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>passphrase <span style=color:#e6db74>&#34;git clone </span>$REPO_REMOTE<span style=color:#e6db74> site&#34;</span> <span style=color:#f92672>&amp;&amp;</span> cd site
</code></pre></div><p>Finally the entrypoint starts gollum with our &lsquo;pyramid of doom&rsquo; custom config:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#75715e>#!/usr/bin/env ruby</span>
require <span style=color:#e6db74>&#39;fileutils&#39;</span>
require <span style=color:#e6db74>&#39;gollum/app&#39;</span>

wiki <span style=color:#f92672>=</span> <span style=color:#66d9ef>Gollum</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Wiki</span><span style=color:#f92672>.</span>new(<span style=color:#e6db74>&#34;.&#34;</span>)

<span style=color:#66d9ef>Thread</span><span style=color:#f92672>.</span>new <span style=color:#66d9ef>do</span>
  <span style=color:#66d9ef>loop</span> <span style=color:#66d9ef>do</span>
    sleep <span style=color:#ae81ff>3</span>
    <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>File</span><span style=color:#f92672>.</span>exists?(<span style=color:#e6db74>&#34;sync&#34;</span>)
      <span style=color:#66d9ef>if</span> system(<span style=color:#e6db74>&#34;git pull origin master&#34;</span>)
        <span style=color:#66d9ef>if</span> system(<span style=color:#e6db74>&#34;git push origin master&#34;</span>)
          content <span style=color:#f92672>=</span> <span style=color:#66d9ef>File</span><span style=color:#f92672>.</span>read(<span style=color:#e6db74>&#34;Home.md&#34;</span>)<span style=color:#f92672>.</span>gsub(<span style=color:#e6db74>/^Updated:.*/</span>, <span style=color:#e6db74>&#34;Updated: </span><span style=color:#e6db74>#{</span><span style=color:#66d9ef>Time</span><span style=color:#f92672>.</span>new<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
          <span style=color:#66d9ef>File</span><span style=color:#f92672>.</span>write(<span style=color:#e6db74>&#34;Home.md&#34;</span>, content)
          system(<span style=color:#e6db74>&#34;git add Home.md; git commit -m update&#34;</span>)

          <span style=color:#66d9ef>File</span><span style=color:#f92672>.</span>delete(<span style=color:#e6db74>&#34;sync&#34;</span>)
        <span style=color:#66d9ef>end</span>
      <span style=color:#66d9ef>end</span>
    <span style=color:#66d9ef>end</span>
  <span style=color:#66d9ef>end</span>
<span style=color:#66d9ef>end</span>

<span style=color:#75715e># Per https://github.com/gollum/gollum-lib/issues/12</span>
<span style=color:#66d9ef>Gollum</span><span style=color:#f92672>::</span><span style=color:#66d9ef>Hook</span><span style=color:#f92672>.</span>register(<span style=color:#e6db74>:post_commit</span>, <span style=color:#e6db74>:hook_id</span>) <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>committer, sha1<span style=color:#f92672>|</span>
  <span style=color:#66d9ef>FileUtils</span><span style=color:#f92672>.</span>touch(<span style=color:#e6db74>&#34;sync&#34;</span>)
<span style=color:#66d9ef>end</span>
</code></pre></div><p>This a little more complex than it needs to be really, but I wanted to have some
kind of acknowledgement that the wiki had update in the gollum interface. The
easiest way to get this working was writing a timestamp to the homepage. Yeah,
yeah&mldr;</p><p>I run the updates to git in another ruby thread to keep the wiki responsive.</p><h3 id=deploy-that-thang>Deploy that thang</h3><p>The deployment is really boring. Just run the container with some secrets
available.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>apiVersion</span>: apps/v1
<span style=color:#66d9ef>kind</span>: Deployment
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>name</span>: wiki
  <span style=color:#66d9ef>labels</span>:
    <span style=color:#66d9ef>app</span>: wiki
  <span style=color:#66d9ef>namespace</span>: wiki
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>replicas</span>: <span style=color:#ae81ff>1</span>
  <span style=color:#66d9ef>selector</span>:
    <span style=color:#66d9ef>matchLabels</span>:
      <span style=color:#66d9ef>app</span>: wiki
  <span style=color:#66d9ef>template</span>:
    <span style=color:#66d9ef>metadata</span>:
      <span style=color:#66d9ef>labels</span>:
        <span style=color:#66d9ef>app</span>: wiki
    <span style=color:#66d9ef>spec</span>:
      <span style=color:#66d9ef>containers</span>:
      - <span style=color:#66d9ef>name</span>: web
        <span style=color:#66d9ef>image</span>: charlieegan3/wiki:1e6007ff832f6afaa7c2b15e1044f907
        <span style=color:#66d9ef>args</span>: [<span style=color:#e6db74>&#34;make&#34;</span>, <span style=color:#e6db74>&#34;server&#34;</span>]
        <span style=color:#66d9ef>envFrom</span>:
        - <span style=color:#66d9ef>secretRef</span>:
            <span style=color:#66d9ef>name</span>: wiki-config
        <span style=color:#66d9ef>ports</span>:
        - <span style=color:#66d9ef>containerPort</span>: <span style=color:#ae81ff>4567</span>
        <span style=color:#66d9ef>resources</span>:
          <span style=color:#66d9ef>limits</span>:
            <span style=color:#66d9ef>cpu</span>: <span style=color:#e6db74>&#34;100m&#34;</span>
            <span style=color:#66d9ef>memory</span>: <span style=color:#e6db74>&#34;100Mi&#34;</span>
          <span style=color:#66d9ef>requests</span>:
            <span style=color:#66d9ef>cpu</span>: <span style=color:#e6db74>&#34;100m&#34;</span>
            <span style=color:#66d9ef>memory</span>: <span style=color:#e6db74>&#34;100Mi&#34;</span>
</code></pre></div><p><code>make server</code> just runs <code>gollum -c config.rb</code> which starts the gollum server
with our config above.</p><p>The ingress is a little more interesting, we can see the annotations for the
oauth proxy:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#66d9ef>apiVersion</span>: extensions/v1beta1
<span style=color:#66d9ef>kind</span>: Ingress
<span style=color:#66d9ef>metadata</span>:
  <span style=color:#66d9ef>name</span>: wiki
  <span style=color:#66d9ef>namespace</span>: wiki
  <span style=color:#66d9ef>labels</span>:
    <span style=color:#66d9ef>app</span>: wiki
  <span style=color:#66d9ef>annotations</span>:
    <span style=color:#66d9ef>certmanager.k8s.io/cluster-issuer</span>: <span style=color:#e6db74>&#34;letsencrypt-prod&#34;</span>
    <span style=color:#66d9ef>kubernetes.io/ingress.class</span>: nginx
    <span style=color:#66d9ef>nginx.ingress.kubernetes.io/auth-url</span>: <span style=color:#e6db74>&#34;https://subdomain.example.com.com/oauth2/auth&#34;</span>
    <span style=color:#66d9ef>nginx.ingress.kubernetes.io/auth-signin</span>: <span style=color:#e6db74>&#34;https://subdomain.example.com/oauth2/start?rd=https%3A%2F%2Fsubdomain.example.com&#34;</span>
<span style=color:#66d9ef>spec</span>:
  <span style=color:#66d9ef>tls</span>:
  - <span style=color:#66d9ef>hosts</span>:
    - subdomain.example.com
    <span style=color:#66d9ef>secretName</span>: wiki-tls
  <span style=color:#66d9ef>rules</span>:
  - <span style=color:#66d9ef>host</span>: subdomain.example.com
    <span style=color:#66d9ef>http</span>:
      <span style=color:#66d9ef>paths</span>:
      - <span style=color:#66d9ef>path</span>: /
        <span style=color:#66d9ef>backend</span>:
          <span style=color:#66d9ef>serviceName</span>: wiki
          <span style=color:#66d9ef>servicePort</span>: <span style=color:#ae81ff>80</span>
</code></pre></div><h2 id=conclusion>Conclusion</h2><p>It works - just about.</p><p>This gives me a wiki that only I can access, that&rsquo;s encrypted and available on
all my devices. I didn&rsquo;t even need to build the interface #winning.</p><p>(but wow, GPG UI so hard&mldr;)</p></div></section></body></html>